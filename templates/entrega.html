{% extends "base.html" %}

{% block content %}

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div>
        <div class="d-flex align-items-center gap-2 mb-1">
          <span class="icon-chip"><i class="bi bi-truck"></i></span>
          <h4 class="mb-0">Entregas</h4>
        </div>
        <div class="text-muted small">
          Registre entregas e filtre por mês, nome, categoria ou equipe.
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-success btn-fixed"
           href="/entrega/excel?mes={{ mes_selecionado }}&nome={{ filtro_nome }}&categoria={{ filtro_categoria }}&equipe={{ filtro_equipe }}">
          <i class="bi bi-file-earmark-excel"></i> Excel
        </a>
        <a class="btn btn-outline-danger btn-fixed"
           href="/entrega/pdf?mes={{ mes_selecionado }}&nome={{ filtro_nome }}&categoria={{ filtro_categoria }}&equipe={{ filtro_equipe }}">
          <i class="bi bi-filetype-pdf"></i> PDF
        </a>
      </div>
    </div>
  </div>
</div>

<!-- FILTROS -->
<div class="card shadow-sm mb-3">
  <div class="card-header header-soft-success d-flex align-items-center gap-2">
    <span class="header-icon"><i class="bi bi-funnel"></i></span>
    <strong>Filtros</strong>
  </div>

  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">

      <div class="col-12 col-md-3">
        <label class="form-label">Mês</label>
        <input type="text"
               name="mes"
               value="{{ mes_selecionado or '' }}"
               class="form-control js-month"
               placeholder="Mês / Ano"
               autocomplete="off">
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Nome</label>
        <input type="text"
               name="nome"
               value="{{ filtro_nome or '' }}"
               class="form-control"
               placeholder="Digite um nome...">
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Categoria</label>
        <select name="categoria" class="form-select">
          <option value="">(Todas)</option>
          {% for c in categorias_lista %}
            <option value="{{ c }}" {% if (filtro_categoria or '') == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Equipe</label>
        <select name="equipe" class="form-select">
          <option value="">(Todas)</option>
          {% for e in equipes_lista %}
            <option value="{{ e }}" {% if (filtro_equipe or '') == e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-outline-primary btn-fixed" type="submit">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
        <a class="btn btn-outline-secondary btn-fixed" href="/entrega">
          <i class="bi bi-x-circle"></i> Limpar
        </a>
      </div>
    </form>

    {% if totais_filtrados %}
      <hr class="my-3">
      <div class="d-flex flex-wrap gap-2">
        <span class="badge text-bg-success badge-litros">
          <i class="bi bi-droplet"></i>
          Gasolina: {{ (totais_filtrados.get('gasolina', 0) or 0) | int }}L
        </span>
        <span class="badge text-bg-warning badge-litros">
          <i class="bi bi-droplet-half"></i>
          Diesel: {{ (totais_filtrados.get('diesel', 0) or 0) | int }}L
        </span>
      </div>
    {% endif %}
  </div>
</div>

<div class="row g-3">

  <!-- REGISTRAR ENTREGA -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header header-soft d-flex align-items-center gap-2">
        <span class="header-icon"><i class="bi bi-plus-circle"></i></span>
        <strong>Registrar entrega</strong>
      </div>

      <div class="card-body">
        {% if pessoas|length == 0 %}
          <div class="empty-state">
            <div class="fw-semibold mb-1">Nenhum cadastro disponível</div>
            <div class="text-muted small">
              Cadastre pessoas/setores antes de registrar entregas.
            </div>
            <a class="btn btn-primary btn-fixed mt-3" href="/cadastro">
              <i class="bi bi-person-plus"></i> Ir para cadastro
            </a>
          </div>
        {% else %}
          <form method="post" class="row g-3" id="formEntrega" autocomplete="off">
            {{ csrf_input()|safe }}

            <!-- mantém filtros após salvar -->
            <input type="hidden" name="mes_filtro" value="{{ mes_selecionado or '' }}">
            <input type="hidden" name="nome_filtro" value="{{ filtro_nome or '' }}">
            <input type="hidden" name="categoria_filtro" value="{{ filtro_categoria or '' }}">
            <input type="hidden" name="equipe_filtro" value="{{ filtro_equipe or '' }}">

            <div class="col-12">
              <label class="form-label">Para</label>
              <select name="pessoa_id" required class="form-select" id="pessoaSelect">
                {% for p in pessoas %}
                  <option value="{{ p[0] }}">{{ p[1] }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Data</label>
              <input type="date"
                     name="data"
                     required
                     class="form-control js-date"
                     placeholder="dd/mm/aaaa"
                     id="dataInput"
                     autocomplete="off">
            </div>

            <!-- POSTO -->
            <div class="col-12">
              <label class="form-label">Posto</label>
              <select name="posto" required class="form-select" id="postoSelect">
                <option value="CIDADE" selected>Cidade</option>
                <option value="ESTRADA">Estrada</option>
                <option value="PONTAO">Pontão</option>
              </select>
              <div class="form-text">
                Selecione onde a pessoa pegou o combustível.
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Quantidade (L)</label>
              <input type="number" step="0.01" name="quantidade" required class="form-control" id="qtdInput" placeholder="Litros">
            </div>

            <div class="col-12">
              <label class="form-label">Combustível</label>
              <select name="combustivel" required class="form-select" id="combSelect">
                <option value="gasolina">Gasolina</option>
                <option value="diesel">Diesel</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Observação</label>
              <input type="text" name="observacao" class="form-control" id="obsInput">
            </div>

            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-fixed" type="submit">
                <i class="bi bi-save"></i> Salvar entrega
              </button>
            </div>
          </form>

          <div class="text-muted small mt-2">
            Ao salvar, o sistema mantém o mês e filtros aplicados.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- LISTA -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header header-soft-warning d-flex align-items-center gap-2">
        <span class="header-icon"><i class="bi bi-list-ul"></i></span>
        <strong>Entregas registradas</strong>
      </div>

      <div class="card-body">
        {% if entregas|length == 0 %}
          <div class="empty-state">
            <div class="fw-semibold mb-1">Nenhuma entrega encontrada</div>
            <div class="text-muted small">
              Ajuste os filtros ou registre uma nova entrega.
            </div>
          </div>
        {% else %}
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Data</th>
                  <th>Nome</th>
                  <th>Categoria</th>
                  <th>Equipe</th>
                  <th>Posto</th>
                  <th>Qtd</th>
                  <th>Comb.</th>
                  <th>Obs.</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for e in entregas %}
                <tr>
                  <td>{{ e[3] | data_br }}</td>
                  <td class="fw-semibold">{{ e[6] }}</td>
                  <td>{{ e[7] }}</td>
                  <td>{{ e[8] }}</td>

                  <td>
                    {% set p = (e[9] if (e|length) > 9 else '') %}
                    {% if p == 'PONTAO' %}
                      Pontão
                    {% elif p == 'ESTRADA' %}
                      Estrada
                    {% elif p == 'CIDADE' %}
                      Cidade
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <td>
                    <span class="badge text-bg-secondary badge-litros">{{ e[2] | int }}L</span>
                  </td>
                  <td>{{ e[5] }}</td>
                  <td class="text-truncate" style="max-width:180px">{{ e[4] or '' }}</td>

                  <td class="text-end d-flex justify-content-end gap-2 flex-wrap">

                    <a class="btn btn-sm btn-outline-primary btn-fixed"
                       href="/entrega/editar/{{ e[0] }}">
                      <i class="bi bi-pencil"></i> Editar
                    </a>

                    <form method="post"
                          action="/entrega/apagar/{{ e[0] }}"
                          class="d-inline m-0"
                          onsubmit="return confirm('Tem certeza que deseja apagar esta entrega?')">
                      {{ csrf_input()|safe }}
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                      <button class="btn btn-sm btn-outline-danger btn-fixed" type="submit">
                        <i class="bi bi-trash"></i> Apagar
                      </button>
                    </form>

                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<!-- MODAL CONFIRMAÇÃO -->
<div class="modal fade" id="modalConfirmEntrega" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-soft">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-check2-circle me-2"></i> Confirmar entrega
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="text-muted mb-2">Confira os dados antes de salvar:</div>

        <div class="confirm-grid">
          <div class="rowline"><span class="k">Pessoa:</span> <span class="v" id="cfPessoa">-</span></div>
          <div class="rowline"><span class="k">Data:</span> <span class="v" id="cfData">-</span></div>
          <div class="rowline"><span class="k">Posto:</span> <span class="v" id="cfPosto">-</span></div>
          <div class="rowline"><span class="k">Quantidade:</span> <span class="v" id="cfQtd">-</span></div>
          <div class="rowline"><span class="k">Combustível:</span> <span class="v" id="cfComb">-</span></div>
        </div>

        <div class="mt-3 d-none" id="boxCotaAviso">
          <div class="alert alert-warning mb-0" id="alertCota">
            <div class="fw-semibold">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Atenção: esta entrega pode ultrapassar a cota
            </div>
            <div class="small mt-1" id="cotaTexto">...</div>
          </div>
        </div>

        <div class="mt-3 d-none" id="boxErro">
          <div class="alert alert-danger mb-0">
            <i class="bi bi-x-circle me-1"></i>
            <span id="erroTexto">Erro</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-fixed" data-bs-dismiss="modal">
          Voltar
        </button>
        <button type="button" class="btn btn-success btn-fixed" id="btnConfirmarSalvar">
          <i class="bi bi-check2-square me-1"></i> Confirmar e salvar
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  var form = document.getElementById('formEntrega');
  if (!form) return;

  var pessoaSelect = document.getElementById('pessoaSelect');
  var dataInput = document.getElementById('dataInput');
  var qtdInput = document.getElementById('qtdInput');
  var combSelect = document.getElementById('combSelect');
  var postoSelect = document.getElementById('postoSelect');

  var cfPessoa = document.getElementById('cfPessoa');
  var cfData = document.getElementById('cfData');
  var cfPosto = document.getElementById('cfPosto');
  var cfQtd = document.getElementById('cfQtd');
  var cfComb = document.getElementById('cfComb');

  var boxCotaAviso = document.getElementById('boxCotaAviso');
  var cotaTexto = document.getElementById('cotaTexto');
  var alertCota = document.getElementById('alertCota');

  var boxErro = document.getElementById('boxErro');
  var erroTexto = document.getElementById('erroTexto');

  var btnConfirmarSalvar = document.getElementById('btnConfirmarSalvar');

  function fmtL(n){
    var v = parseFloat(n);
    if (isNaN(v)) return "0 L";
    return (v % 1 === 0 ? v.toFixed(0) : v.toFixed(2)) + " L";
  }

  function postoLabel(v){
    v = (v || "").toUpperCase();
    if (v === "PONTAO") return "Pontão";
    if (v === "ESTRADA") return "Estrada";
    return "Cidade";
  }

  function resetAvisos(){
    boxCotaAviso.classList.add('d-none');
    boxErro.classList.add('d-none');
    alertCota.classList.remove('alert-danger');
    alertCota.classList.add('alert-warning');
    btnConfirmarSalvar.classList.remove('btn-danger-soft');
    btnConfirmarSalvar.classList.add('btn-success');
    btnConfirmarSalvar.innerHTML = '<i class="bi bi-check2-square me-1"></i> Confirmar e salvar';
  }

  function setBotaoCritico(isCritico){
    btnConfirmarSalvar.classList.remove('btn-success', 'btn-danger-soft');
    if (isCritico){
      btnConfirmarSalvar.classList.add('btn-danger-soft');
      btnConfirmarSalvar.innerHTML = '<i class="bi bi-exclamation-octagon me-1"></i> Confirmar mesmo assim';
    } else {
      btnConfirmarSalvar.classList.add('btn-success');
      btnConfirmarSalvar.innerHTML = '<i class="bi bi-check2-square me-1"></i> Confirmar e salvar';
    }
  }

  async function checarCota(pessoaId, mes, qtdNova){
    var url = "/api/cota-status?pessoa_id=" + encodeURIComponent(pessoaId) + "&mes=" + encodeURIComponent(mes);
    var resp = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
    var data = await resp.json();
    if (!data.ok) throw new Error(data.erro || "Falha ao consultar cota.");

    var cota = parseFloat(data.cota || 0);
    var totalMes = parseFloat(data.total_mes || 0);
    var novoTotal = totalMes + parseFloat(qtdNova || 0);
    var novoSaldo = cota - novoTotal;

    return { cota, totalMes, novoTotal, novoSaldo };
  }

  var modalEl = document.getElementById('modalConfirmEntrega');
  if (!modalEl || !window.bootstrap) return;
  var modal = new bootstrap.Modal(modalEl);

  var bypassModal = false;

  form.addEventListener('submit', async function(ev){
    if (bypassModal) return;

    ev.preventDefault();
    resetAvisos();

    var pessoaId = pessoaSelect.value;
    var pessoaNome = pessoaSelect.options[pessoaSelect.selectedIndex]
      ? pessoaSelect.options[pessoaSelect.selectedIndex].text
      : "-";

    var dataStr = (dataInput.value || "").trim();
    var qtdStr = (qtdInput.value || "").trim();
    var comb = combSelect.value || "-";
    var postoVal = (postoSelect && postoSelect.value) ? postoSelect.value : "CIDADE";

    cfPessoa.textContent = pessoaNome;
    cfData.textContent = dataStr ? dataStr : "-";
    cfPosto.textContent = postoLabel(postoVal);
    cfQtd.textContent = fmtL(qtdStr || 0);
    cfComb.textContent = comb;

    if (!/^\d{4}-\d{2}-\d{2}$/.test(dataStr)){
      boxErro.classList.remove('d-none');
      erroTexto.textContent = "Informe uma data válida.";
      modal.show();
      return;
    }

    var mes = dataStr.slice(0,7);

    try{
      var qtdNum = parseFloat(qtdStr || 0);
      if (!qtdNum || qtdNum <= 0){
        boxErro.classList.remove('d-none');
        erroTexto.textContent = "Quantidade deve ser maior que zero.";
        modal.show();
        return;
      }

      var cotaInfo = await checarCota(pessoaId, mes, qtdNum);

      if (cotaInfo.cota > 0){
        if (cotaInfo.novoSaldo < 0){
          boxCotaAviso.classList.remove('d-none');
          alertCota.classList.remove('alert-warning');
          alertCota.classList.add('alert-danger');

          setBotaoCritico(true);

          cotaTexto.innerHTML =
            "Cota: <strong>" + fmtL(cotaInfo.cota) + "</strong> • " +
            "Já entregue no mês: <strong>" + fmtL(cotaInfo.totalMes) + "</strong><br>" +
            "Após salvar: total <strong>" + fmtL(cotaInfo.novoTotal) + "</strong> • " +
            "Saldo ficará: <strong>" + fmtL(cotaInfo.novoSaldo) + "</strong>";
        } else if (cotaInfo.novoSaldo <= (cotaInfo.cota * 0.1)){
          boxCotaAviso.classList.remove('d-none');
          alertCota.classList.remove('alert-danger');
          alertCota.classList.add('alert-warning');

          cotaTexto.innerHTML =
            "Cota: <strong>" + fmtL(cotaInfo.cota) + "</strong> • " +
            "Já entregue no mês: <strong>" + fmtL(cotaInfo.totalMes) + "</strong><br>" +
            "Após salvar: saldo ficará: <strong>" + fmtL(cotaInfo.novoSaldo) + "</strong>";
        }
      }
    } catch(e){
      boxErro.classList.remove('d-none');
      erroTexto.textContent = (e && e.message) ? e.message : "Erro ao checar cota.";
    }

    modal.show();
  });

  btnConfirmarSalvar.addEventListener('click', function(){
    bypassModal = true;
    form.submit();
  });

})();
</script>
{% endblock %}
